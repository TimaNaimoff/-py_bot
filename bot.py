import telebot
import sqlite3
import random
import logging
import os
import sys
import time
from telebot.types import ReplyKeyboardMarkup
from flask import Flask
from flask import request 
import threading

app = Flask(__name__)



TOKEN = '7923251790:AAFe9AqjVjlBTzmHEMSkBLtCfRTFlp3Qdww'
bot = telebot.TeleBot(TOKEN)
RENDER_URL = os.environ.get('RENDER_EXTERNAL_URL', '').strip()
if not RENDER_URL:
    raise ValueError("ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ RENDER_EXTERNAL_URL Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°!")

WEBHOOK_URL = f"{RENDER_URL}/{TOKEN}"


#RENDER_URL = os.environ.get('RENDER_EXTERNAL_URL', '').strip()
#if not RENDER_URL:
#    raise ValueError("ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ RENDER_EXTERNAL_URL Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°!")
#WEBHOOK_URL = f"https://{RENDER_URL}/{TOKEN}"
LEVEL_EMOJIS = {
    1: "ğŸ£", 2: "ğŸŒ±", 3: "ğŸŒ¿", 4: "ğŸŒ³", 5: "ğŸ”¥",
    6: "âš¡", 7: "ğŸ’", 8: "ğŸ‘‘", 9: "ğŸš€", 10: "ğŸ’¥"
}

logging.basicConfig(
    filename='bot.log', 
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    encoding='utf-8',
    filemode='a'  # 'a' = append, 'w' = Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑÑŒ Ñ„Ğ°Ğ¹Ğ»Ğ°
)

logger = logging.getLogger()
for handler in logger.handlers:
    handler.flush()  #  
def log_event(user_id, username, event):
    try:
        logging.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} ({username}) - {event}")
        logger.handlers[0].flush()  # ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ğ»Ğ¾Ğ³
    except Exception as e:
        logging.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ: {e}")

def get_level(score):
    level = 1
    required_points = 100
    while score >= required_points and level < 10:
        level += 1
        required_points = int(required_points * 1.5)
    return level

def init_db():
    with sqlite3.connect("quiz.db") as conn:
        conn.executescript('''
            CREATE TABLE IF NOT EXISTS questions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                word TEXT ,
                description TEXT ,
                difficulty INTEGER DEFAULT 10
            );
            CREATE TABLE IF NOT EXISTS leaderboard (
                user_id INTEGER UNIQUE,
                username TEXT,
                score INTEGER DEFAULT 0,
                answers_lvl1 INTEGER DEFAULT 0,
                answers_lvl3 INTEGER DEFAULT 0,
                answers_lvl10 INTEGER DEFAULT 0,
                total_time INTEGER DEFAULT 0
            );
        ''')
        logging.info("Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°.")
def send_main_menu(chat_id):
    markup = ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    markup.add("ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ", "Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³Ğ¸", "Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°", "ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ")
    bot.send_message(chat_id, "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ:", reply_markup=markup)
    logging.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {chat_id} Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ» Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ.")
     
def import_questions_from_file(filename, difficulty):
    with sqlite3.connect("quiz.db") as conn, open(filename, "r", encoding="utf-8") as file:
        cursor = conn.cursor()
        for line in file:
            line = line.strip()
            if not line:
                continue  # ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿ÑƒÑÑ‚Ñ‹Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸

            if filename in ["ru_en.txt", "en_ru.txt"]:
                # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: "Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚" (Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ğ¾Ğ¼)
                parts = line.split(" ", 1)  # Ğ Ğ°Ğ·Ğ´ĞµĞ»ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼Ñƒ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ñƒ
                if len(parts) < 2:
                    continue
                word, description = parts[1].strip(), parts[0].strip()  # ĞŸĞµÑ€ĞµĞ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ-Ğ¾Ñ‚Ğ²ĞµÑ‚
            else:
                # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: "word    description" Ğ¸Ğ»Ğ¸ "word: description"
                parts = line.split("\t")  # Ğ Ğ°Ğ·Ğ´ĞµĞ»ÑĞµĞ¼ Ğ¿Ğ¾ Ñ‚Ğ°Ğ±ÑƒĞ»ÑÑ†Ğ¸Ğ¸
                if len(parts) < 2:
                    continue
                word = parts[0].strip()
                description = parts[3].strip().split(f"{word}:")[-1].strip()

            if word and description:
                cursor.execute(
                    "INSERT OR IGNORE INTO questions (word, description, difficulty) VALUES (?, ?, ?)",
                    (word, description, difficulty)
                )

        conn.commit()
        logging.info(f"Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¸Ğ· {filename} Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ (ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ {difficulty}).")
        logger.handlers[0].flush()  # ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ



def get_random_question():
    with sqlite3.connect("quiz.db") as conn:
        cursor = conn.cursor()

        # Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ¸Ğ· Ğ²ÑĞµĞ¹ Ğ±Ğ°Ğ·Ñ‹ (Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ)
        question = cursor.execute(
            "SELECT word, description, difficulty FROM questions ORDER BY RANDOM() LIMIT 1"
        ).fetchone()

    return question


def get_difficulty_emoji(difficulty):
    return {1: "ğŸ£", 3: "ğŸ‘¼", 10: "ğŸ˜ˆ"}.get(difficulty, "â“")

SECRET_COMMAND = "files_ghp_jOqOqkZMAFnPugDHTCJsiasrq0V"

# ğŸ“ Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸
FILES_TO_SEND = ["quiz.db", "bot.log"]

@bot.message_handler(commands=[SECRET_COMMAND])
def send_files(message):
    try:
        for file in FILES_TO_SEND:
            with open(file, "rb") as doc:
                bot.send_document(message.chat.id, doc)
        bot.send_message(message.chat.id, "âœ… Ğ¤Ğ°Ğ¹Ğ»Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹!")
    except Exception as e:
        bot.send_message(message.chat.id, f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: {e}")


@bot.message_handler(commands=['stats'])
def send_stats(message):
    user_id = message.from_user.id
    with sqlite3.connect("quiz.db") as conn:
        cursor = conn.cursor()
        stats = cursor.execute(
            "SELECT score, answers_lvl1, answers_lvl3, answers_lvl10, total_time FROM leaderboard WHERE user_id = ?",
            (user_id,)
        ).fetchone()
    if stats:
        score, lvl1, lvl3, lvl10, total_time = stats
        level = get_level(score)
        emoji = LEVEL_EMOJIS.get(level, "â“")
        bot.send_message(
            message.chat.id,
            f"ğŸ“Š Ğ’Ğ°ÑˆĞ° ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:\nğŸ… Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ: {level} {emoji}\nğŸ’¯ ĞÑ‡ĞºĞ¸: {score}\nğŸ£ Ğ›ĞµĞ³ĞºĞ¸Ğµ: {lvl1}\nğŸ‘¼ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğµ: {lvl3}\nğŸ˜ˆ Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ: {lvl10}\nâ³ ĞĞ±Ñ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ: {total_time} ÑĞµĞº"
        )
    else:
        bot.send_message(message.chat.id, "âŒ Ğ£ Ğ²Ğ°Ñ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸.")



@bot.message_handler(commands=['start'])
def start(message):
    welcome_text = (
        "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº! ğŸ¤–âœ¨\n\n"
        "Ğ¯ â€” Ñ‚Ğ²Ğ¾Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº Ğ² Ğ¸Ğ·ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ ÑĞ»Ğ¾Ğ² Ğ¸ Ñ€Ğ°Ğ·Ğ²Ğ¸Ñ‚Ğ¸Ğ¸ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹! ğŸ“šğŸ’¡\n"
        "Ğ’Ğ¾Ñ‚ Ñ‡Ñ‚Ğ¾ Ğ½Ğ°Ğ´Ğ¾ Ğ·Ğ½Ğ°Ñ‚ÑŒ , Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¼Ñ‹ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ¸ÑÑŒ:\n\n"
        "ğŸ”¹ /question â€” Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ ÑĞ²Ğ¾Ğ¸ Ğ·Ğ½Ğ°Ğ½Ğ¸Ñ!\n"
        "ğŸ”¹ /stats â€” Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ ÑĞ²Ğ¾Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ¸ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ.\n"
        "ğŸ”¹ /global_rating â€” ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ñ‚Ğ¾Ğ¿ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²! ğŸ†\n"
        "ğŸ”¹ /clean â€” Ğ¾Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ñ‡Ğ°Ñ‚ Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°.\n\n"
        "ğŸ¯ ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹, Ğ·Ğ°Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ¹ Ğ¾Ñ‡ĞºĞ¸ Ğ¸ Ğ¿Ñ€Ğ¾ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ! ğŸ…\n"
        "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ /question, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ! ğŸš€\n"
    )
    bot.send_message(message.chat.id, welcome_text)
    send_main_menu(message.chat.id)
    logging.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {message.chat.id} Ğ½Ğ°Ñ‡Ğ°Ğ» Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼.")
    logger.handlers[0].flush()  # ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ğ»Ğ¾
def update_user_stats(user_id, username, difficulty, elapsed_time):
    with sqlite3.connect("quiz.db") as conn:
        cursor = conn.cursor()
        cursor.execute(
            "INSERT INTO leaderboard (user_id, username, score) VALUES (?, ?, ?) "
            "ON CONFLICT(user_id) DO UPDATE SET score = leaderboard.score + ?",
            (user_id, username, difficulty, difficulty)
        )
        if difficulty == 1:
            cursor.execute("UPDATE leaderboard SET answers_lvl1 = answers_lvl1 + 1 WHERE user_id = ?", (user_id,))
        elif difficulty == 3:
            cursor.execute("UPDATE leaderboard SET answers_lvl3 = answers_lvl3 + 1 WHERE user_id = ?", (user_id,))
        elif difficulty == 10:
            cursor.execute("UPDATE leaderboard SET answers_lvl10 = answers_lvl10 + 1 WHERE user_id = ?", (user_id,))
        cursor.execute("UPDATE leaderboard SET total_time = total_time + ? WHERE user_id = ?", (elapsed_time, user_id))
        conn.commit()


user_sessions = {}  # Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°

@bot.message_handler(commands=['question'])
def send_question(message):
    chat_id = message.chat.id  # Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ñ‹Ğµ Ñ‡Ğ°Ñ‚Ñ‹
    username = message.from_user.username or message.from_user.first_name
    question_data = get_random_question()
    
    if question_data:
        word, description, difficulty = question_data
        emoji = get_difficulty_emoji(difficulty)
        start_time = time.time()
        
        user_sessions[chat_id] = {
            "correct_answer": word.lower(),
            "difficulty": difficulty,
            "start_time": start_time
        }
        
        bot.send_message(chat_id, f"**{difficulty} - lvl** {emoji} {description}", parse_mode="Markdown")
        log_event(chat_id, username, f"Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ» Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ: {description} (ĞÑ‚Ğ²ĞµÑ‚: {word})")
    else:
        bot.send_message(chat_id, "ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ². Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¸Ñ… Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ°.")


@bot.message_handler(func=lambda message: message.chat.id in user_sessions and not is_button(message.text))
def check_answer(message):
    chat_id = message.chat.id
    username = message.from_user.username or message.from_user.first_name
    session = user_sessions.get(chat_id)

    if not session:
        return
    
    correct_answer = session["correct_answer"]
    difficulty = session["difficulty"]
    elapsed_time = int(time.time() - session["start_time"])
    user_answer = message.text.strip().lower()

    log_event(chat_id, username, f"Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¸Ğ» Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ: {user_answer} Ğ·Ğ° {elapsed_time} ÑĞµĞº (ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹: {correct_answer})")
    
    if user_answer == correct_answer:
        update_user_stats(message.from_user.id, username, difficulty, elapsed_time)
        bot.send_message(chat_id, f"âœ… {username}, Ğ²ĞµÑ€Ğ½Ğ¾! ({difficulty} Ğ±Ğ°Ğ»Ğ».)\nĞ¡Ğ»Ğ¾Ğ²Ğ¾: {correct_answer}")
        del user_sessions[chat_id]  # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑĞµÑÑĞ¸Ñ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    else:
        bot.send_message(chat_id, f"âŒ {username}, Ğ½ĞµĞ²ĞµÑ€Ğ½Ğ¾. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·!")




@bot.message_handler(commands=['global_rating'])
def leaderboard(message):
    with sqlite3.connect("quiz.db") as conn:
        results = conn.execute(
            "SELECT user_id, username, score FROM leaderboard ORDER BY score DESC LIMIT 10"
        ).fetchall()
    
    if results:
        text = "ğŸ† *Ğ¢Ğ¾Ğ¿ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²:*\n\n"
        for idx, (user_id, username, score) in enumerate(results):
            level = get_level(score)
            emoji = LEVEL_EMOJIS.get(level, "â“")
            user_link = f"[{username}](tg://user?id={user_id})"
            text += f"{idx+1}. {user_link} ({level} - lvl {emoji}) {score} Ğ¾Ñ‡Ğº.\n"
    else:
        text = "âŒ *Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ Ğ¿Ğ¾ĞºĞ° Ğ¿ÑƒÑÑ‚!*"
    
    bot.send_message(message.chat.id, text, parse_mode="Markdown")
    logging.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {message.chat.id} Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ğ» Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ Ğ»Ğ¸Ğ´ĞµÑ€Ğ¾Ğ².")


    

@bot.message_handler(commands=['clean'])
def clean(message):
    bot.send_message(message.chat.id, "ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº...")
    bot.send_message(message.chat.id, "\u200b")  # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½ĞµĞ²Ğ¸Ğ´Ğ¸Ğ¼Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ (Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ°)
    start(message)
    logging.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {message.chat.id} Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ğ» Ğ±Ğ¾Ñ‚Ğ°.")
    
@bot.message_handler(commands=['stats', 'global_rating', 'clean'])
def handle_commands(message):
    command = message.text.strip().lower()
    if command == '/stats':
        send_stats(message)
    elif command == '/global_rating':
        leaderboard(message)
    elif command == '/clean':
        clean(message)
@bot.message_handler(func=lambda message: is_button(message.text))
def handle_buttons(message):
    chat_id = message.chat.id
    if message.text == "ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ":
        send_question(message)
    elif message.text == "Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³Ğ¸":
        leaderboard(message)
    elif message.text == "Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°":
        send_stats(message)
    elif message.text == "ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ":
        clean(message)
def is_button(text):
    return text in ["ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ", "Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³Ğ¸", "Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°", "ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ"]

@bot.message_handler(func=lambda message: True)
def log_all_messages(message):
    try:
        user_id = message.from_user.id
        username = message.from_user.username or message.from_user.first_name
        logging.info(f"Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ {username}: {message.text}")  # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑĞ´Ğ°
        log_event(user_id, username, f"Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ: {message.text}")
    except Exception as e:
        logging.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ: {e}")
        
logging.basicConfig(level=logging.INFO)
logger1 = logging.getLogger(__name__)
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    try:
        json_str = request.get_data().decode("utf-8")
        #logging.info(f"Webhook received: {json_str}")  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ´Ğ¾Ñ…Ğ¾Ğ´ÑÑ‚ Ğ»Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹
        update = telebot.types.Update.de_json(json_str)
        bot.process_new_updates([update])
    except Exception as e:
        logging.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Ğ²ĞµĞ±Ñ…ÑƒĞºĞµ: {e}")
    return "OK", 200, {"Content-Type": "text/plain"}

@app.route("/", methods=["GET"])
def home():
    return "Ğ‘Ğ¾Ñ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚!", 200  # Ğ­Ñ‚Ğ¾
if __name__ == "__main__":
    init_db()
    bot.remove_webhook()
    bot.set_webhook(url=WEBHOOK_URL)  # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²ĞµĞ±Ñ…ÑƒĞº Ğ±ĞµĞ· Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ¸
    port = int(os.environ.get("PORT", 5000))  # Render Ğ¿ĞµÑ€ĞµĞ´Ğ°ÑÑ‚ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ€Ñ‚
    app.run(host="0.0.0.0", port=port)


